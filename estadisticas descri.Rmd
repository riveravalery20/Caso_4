---
title: "estadistica descrip"
author: "La p"
date: "2025-12-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 12,
  fig.height = 7,
  fig.align = 'center'
)
```

```{r librerias, include=FALSE}
library(quantmod)
library(tseries)
library(fpp2)
library(gridExtra)
library(tidyverse)
library(lubridate)
```

```{r cargar datos, include=FALSE}

AccionesEX <- getSymbols("GLTR", src = "yahoo", auto.assign = FALSE, 
                         from = "2022-10-31")

names(AccionesEX)
GLTR <- AccionesEX$GLTR.Close

# Preparar dataframe para análisis descriptivo
GLTR_df <- data.frame(
  Fecha = index(GLTR),
  Precio = as.numeric(GLTR),
  Año = year(index(GLTR)),
  Mes = month(index(GLTR), label = TRUE, abbr = FALSE),
  Dia_Semana = wday(index(GLTR), label = TRUE, abbr = FALSE)
)

```

```{r estadisticas basicas, include=FALSE}
library(gt)
library(dplyr)

estadisticas_basicas <- GLTR_df %>%
  filter(Fecha >= "2022-10-31" & Fecha <= "2025-10-31") %>%
  summarise(
    Media = mean(Precio),
    Mediana = median(Precio),
    Desviacion = sd(Precio),
    Minimo = min(Precio),
    Maximo = max(Precio),
    Q1 = quantile(Precio, 0.25),
    Q3 = quantile(Precio, 0.75)
  ) %>%
  mutate(across(where(is.numeric), ~round(., 2)))

estadisticas_df <- data.frame(
  Estadistica = c("Media", "Mediana", "Desviación Estándar", 
                  "Mínimo", "Máximo", "Primer Cuartil (Q1)", 
                  "Tercer Cuartil (Q3)"),
  Valor = c(
    estadisticas_basicas$Media,
    estadisticas_basicas$Mediana,
    estadisticas_basicas$Desviacion,
    estadisticas_basicas$Minimo,
    estadisticas_basicas$Maximo,
    estadisticas_basicas$Q1,
    estadisticas_basicas$Q3
  )
)

tabla_estadisticas <- estadisticas_df %>%
  gt() %>%
  tab_header(
    title = "Tabla 1. Estadísticas Descriptivas del ETF GLTR",
    subtitle = "Período: Octubre 2022 - Octubre 2025"
  ) %>%
  fmt_currency(
    columns = Valor,
    currency = "USD",
    decimals = 2
  ) %>%
  cols_label(
    Estadistica = "Estadística",
    Valor = "Valor (USD)"
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "#001A5C"),  
      cell_text(color = "white", weight = "bold")
    ),
    locations = cells_column_labels()
  ) %>%
  
  tab_style(
    style = cell_fill(color = "#F5F7FA"), 
    locations = cells_body(rows = seq(1, nrow(estadisticas_df), 2))
  ) %>%
  
  tab_style(
    style = cell_borders(
      sides = c("top", "bottom"),
      color = "#D1D8E0",  # Cambiado a border-light
      weight = px(1)
    ),
    locations = cells_body()
  ) %>%
  # Fuente de nota
  tab_source_note(
    source_note = "Fuente: Datos históricos del ETF GLTR"
  ) %>%
  # Opciones básicas de tabla
  tab_options(
    table.font.names = "Arial",
    heading.title.font.size = px(16),
    heading.subtitle.font.size = px(14),
    table_body.hlines.color = "transparent",
    source_notes.font.size = px(12)
  )

# Mostrar la tabla
tabla_estadisticas


```


```{r boxplot por años , include=FALSE}
library(plotly)
library(dplyr)

GLTR_df <- GLTR_df %>%
  mutate(Fecha = as.Date(Fecha))

GLTR_df <- GLTR_df %>%
  mutate(Año = as.factor(format(Fecha, "%Y"))) %>%
  filter(Año %in% c("2022", "2023", "2024", "2025"))

df_2022 <- GLTR_df %>% filter(Año == "2022")
df_2023 <- GLTR_df %>% filter(Año == "2023")
df_2024 <- GLTR_df %>% filter(Año == "2024")
df_2025 <- GLTR_df %>% filter(Año == "2025")

colors <- c(
  "2022" = "#001A5C",    
  "2023" = "#0056B3",    
  "2024" = "#00B0F0",    
  "2025" = "#00A859",    
  "Todos" = "#5D6D7E"    
)

fig <- plot_ly() %>%
  
  add_boxplot(
    data = df_2022,
    y = ~Precio,
    name = "2022",
    marker = list(
      color = colors["2022"],
      size = 5,
      line = list(color = 'white', width = 1)
    ),
    line = list(color = colors["2022"], width = 2),
    fillcolor = 'rgba(0, 26, 92, 0.3)',
    boxmean = TRUE,
    visible = TRUE
  ) %>%
  
  add_boxplot(
    data = df_2023,
    y = ~Precio,
    name = "2023",
    marker = list(
      color = colors["2023"],
      size = 5,
      line = list(color = 'white', width = 1)
    ),
    line = list(color = colors["2023"], width = 2),
    fillcolor = 'rgba(0, 86, 179, 0.3)',
    boxmean = TRUE,
    visible = TRUE
  ) %>%
  
  add_boxplot(
    data = df_2024,
    y = ~Precio,
    name = "2024",
    marker = list(
      color = colors["2024"],
      size = 5,
      line = list(color = 'white', width = 1)
    ),
    line = list(color = colors["2024"], width = 2),
    fillcolor = 'rgba(0, 176, 240, 0.3)',
    boxmean = TRUE,
    visible = TRUE
  ) %>%
  
  add_boxplot(
    data = df_2025,
    y = ~Precio,
    name = "2025",
    marker = list(
      color = colors["2025"],
      size = 5,
      line = list(color = 'white', width = 1)
    ),
    line = list(color = colors["2025"], width = 2),
    fillcolor = 'rgba(0, 168, 89, 0.3)',
    boxmean = TRUE,
    visible = TRUE
  ) %>%
  
  layout(
    title = list(
      text = "<b>Distribución de Precios del ETF GLTR por Año</b>",
      font = list(
        family = "Roboto, sans-serif",
        size = 22,
        color = "#001A5C"  
      ),
      x = 0.5,
      xanchor = "center",
      y = 0.95
    ),
    xaxis = list(
      title = "<b>Año</b>",
      titlefont = list(
        family = "Roboto, sans-serif",
        size = 16,
        color = "#001A5C" 
      ),
      tickfont = list(
        family = "Inter, sans-serif",
        size = 14,
        color = "#5D6D7E"  
      ),
      showgrid = TRUE,
      gridcolor = "rgba(233, 236, 241, 0.5)",  
      gridwidth = 0.5,
      showline = TRUE,
      linecolor = "#0056B3",  
      linewidth = 1
    ),
    yaxis = list(
      title = "<b>Precio (USD)</b>",
      titlefont = list(
        family = "Roboto, sans-serif",
        size = 16,
        color = "#001A5C"  
      ),
      tickfont = list(
        family = "Inter, sans-serif",
        size = 13,
        color = "#5D6D7E"  
      ),
      tickformat = "$.2f",
      showgrid = TRUE,
      gridcolor = "rgba(233, 236, 241, 0.5)",  
      gridwidth = 0.5,
      zeroline = TRUE,
      zerolinecolor = "#0056B3",  
      zerolinewidth = 1
    ),
    plot_bgcolor = "white",
    paper_bgcolor = "white",
    margin = list(l = 80, r = 40, t = 100, b = 80),
    showlegend = TRUE,
    legend = list(
      orientation = "h",
      x = 0.5,
      xanchor = "center",
      y = -0.15,
      font = list(
        family = "Inter, sans-serif",
        size = 13,
        color = "#2E3842"  
      ),
      bgcolor = "rgba(245, 247, 250, 0.8)",  
      bordercolor = "#D1D8E0",  
      borderwidth = 1
    ),
    hovermode = "x unified",
    
    updatemenus = list(
      list(
        type = "buttons",
        direction = "right",
        x = 0.5,
        xanchor = "center",
        y = 1.15,
        yanchor = "top",
        showactive = TRUE,
        bgcolor = "white",
        bordercolor = "#D1D8E0",  
        borderwidth = 1,
        buttons = list(
          
          list(
            method = "update",
            args = list(
              list(visible = c(TRUE, TRUE, TRUE, TRUE)),
              list(title = "<b>Distribución de Precios del ETF GLTR (Todos los Años)</b>",
                   xaxis = list(title = "<b>Año</b>"))
            ),
            label = "Todos los Años",
            font = list(family = "Inter, sans-serif", size = 12)
          ),
          
          list(
            method = "update",
            args = list(
              list(visible = c(TRUE, FALSE, FALSE, FALSE)),
              list(title = "<b>Distribución de Precios del ETF GLTR (2022)</b>",
                   xaxis = list(title = "<b>2022</b>"))
            ),
            label = "2022",
            font = list(family = "Inter, sans-serif", size = 12)
          ),
          
          list(
            method = "update",
            args = list(
              list(visible = c(FALSE, TRUE, FALSE, FALSE)),
              list(title = "<b>Distribución de Precios del ETF GLTR (2023)</b>",
                   xaxis = list(title = "<b>2023</b>"))
            ),
            label = "2023",
            font = list(family = "Inter, sans-serif", size = 12)
          ),
        
          list(
            method = "update",
            args = list(
              list(visible = c(FALSE, FALSE, TRUE, FALSE)),
              list(title = "<b>Distribución de Precios del ETF GLTR (2024)</b>",
                   xaxis = list(title = "<b>2024</b>"))
            ),
            label = "2024",
            font = list(family = "Inter, sans-serif", size = 12)
          ),
          
          list(
            method = "update",
            args = list(
              list(visible = c(FALSE, FALSE, FALSE, TRUE)),
              list(title = "<b>Distribución de Precios del ETF GLTR (2025)</b>",
                   xaxis = list(title = "<b>2025</b>"))
            ),
            label = "2025",
            font = list(family = "Inter, sans-serif", size = 12)
          )
        )
      )
    )
  ) %>%
  
  layout(
    hoverlabel = list(
      bgcolor = "white",
      bordercolor = "#D1D8E0",  
      font = list(
        family = "Inter, sans-serif",
        size = 13,
        color = "#2E3842"  
      )
    )
  ) %>%
  
  add_annotations(
    text = "<i>Seleccione un año para ver la distribución específica</i>",
    x = 0.5,
    y = -0.2,
    xref = "paper",
    yref = "paper",
    xanchor = "center",
    showarrow = FALSE,
    font = list(
      family = "Inter, sans-serif",
      size = 12,
      color = "#5D6D7E"  
    )
  )


fig

```

```{r tendencia , include=FALSE}
library(plotly)
library(forecast)

serie_ts <- ts(GLTR_df$Precio, 
               start = c(2022, 10), 
               frequency = 365)

descomposicion <- stl(serie_ts, s.window = "periodic")

descomp_df <- data.frame(
  Fecha = GLTR_df$Fecha,
  Original = GLTR_df$Precio,
  Tendencia = as.numeric(descomposicion$time.series[, "trend"])
)

fig_original_tendencia <- plot_ly(descomp_df) %>%
  add_trace(x = ~Fecha, y = ~Original, type = 'scatter', mode = 'lines',
            name = 'Serie Original', 
            line = list(color = 'rgba(0, 86, 179, 0.3)', width = 1),  
            hovertemplate = '<b>Original</b>: $%{y:.2f}<br>%{x|%d-%b-%Y}<extra></extra>') %>%
  
  add_trace(x = ~Fecha, y = ~Tendencia, type = 'scatter', mode = 'lines',
            name = 'Tendencia', 
            line = list(color = '#001A5C', width = 3),  
            hovertemplate = '<b>Tendencia</b>: $%{y:.2f}<br>%{x|%d-%b-%Y}<extra></extra>') %>%
  
  layout(
    title = list(
      text = "<b>Serie Temporal Original y Tendencia del ETF GLTR</b>",
      font = list(
        family = "Roboto, sans-serif",
        size = 22,
        color = "#001A5C"  
      ),
      x = 0.5,
      xanchor = "center",
      y = 0.95
    ),
    xaxis = list(
      title = "<b>Fecha</b>",
      titlefont = list(
        family = "Roboto, sans-serif",
        size = 16,
        color = "#001A5C"  
      ),
      tickfont = list(
        family = "Inter, sans-serif",
        size = 12,
        color = "#5D6D7E"  
      ),
      showgrid = TRUE,
      gridcolor = "rgba(233, 236, 241, 0.5)",  
      gridwidth = 0.5,
      showline = TRUE,
      linecolor = "#0056B3",  
      linewidth = 1.5,
      rangeslider = list(visible = FALSE)  
    ),
    yaxis = list(
      title = "<b>Precio (USD)</b>",
      titlefont = list(
        family = "Roboto, sans-serif",
        size = 16,
        color = "#001A5C"  
      ),
      tickfont = list(
        family = "Inter, sans-serif",
        size = 13,
        color = "#5D6D7E"  
      ),
      tickformat = "$.2f",
      showgrid = TRUE,
      gridcolor = "rgba(233, 236, 241, 0.5)", 
      gridwidth = 0.5,
      zeroline = TRUE,
      zerolinecolor = "#0056B3",  
      zerolinewidth = 1
    ),
    plot_bgcolor = "white",
    paper_bgcolor = "white",
    margin = list(l = 80, r = 40, t = 100, b = 80),
    hovermode = "x unified",
  
    updatemenus = list(
      list(
        type = "buttons",
        direction = "right",
        x = 0.5,
        xanchor = "center",
        y = 1.15,
        yanchor = "top",
        showactive = TRUE,
        bgcolor = "white",
        bordercolor = "#D1D8E0",  
        borderwidth = 1,
        buttons = list(
          
          list(
            method = "update",
            args = list(
              list(visible = c(TRUE, TRUE)),
              list(title = "<b>Serie Temporal Original y Tendencia del ETF GLTR</b>")
            ),
            label = "Mostrar Ambas",
            font = list(family = "Inter, sans-serif", size = 12)
          ),
          
          list(
            method = "update",
            args = list(
              list(visible = c(TRUE, FALSE)),
              list(title = "<b>Serie Temporal Original del ETF GLTR</b>")
            ),
            label = "Solo Original",
            font = list(family = "Inter, sans-serif", size = 12)
          ),
          
          list(
            method = "update",
            args = list(
              list(visible = c(FALSE, TRUE)),
              list(title = "<b>Tendencia de la Serie Temporal del ETF GLTR</b>")
            ),
            label = "Solo Tendencia",
            font = list(family = "Inter, sans-serif", size = 12)
          )
        )
      )
    ),
    
    legend = list(
      orientation = "h",
      x = 0.5,
      xanchor = "center",
      y = -0.15,
      font = list(
        family = "Inter, sans-serif",
        size = 13,
        color = "#2E3842"  
      ),
      bgcolor = "rgba(245, 247, 250, 0.8)",  
      bordercolor = "#D1D8E0",  
      borderwidth = 1
    )
  ) %>%

  layout(
    hoverlabel = list(
      bgcolor = "white",
      bordercolor = "#D1D8E0",  
      font = list(
        family = "Inter, sans-serif",
        size = 13,
        color = "#2E3842"  
      )
    )
  ) %>%
  
  add_annotations(
    text = "<i>La línea azul muestra los precios originales diarios. La línea azul oscuro muestra la tendencia suavizada.</i>",
    x = 0.5,
    y = -0.25,
    xref = "paper",
    yref = "paper",
    xanchor = "center",
    showarrow = FALSE,
    font = list(
      family = "Inter, sans-serif",
      size = 12,
      color = "#5D6D7E"  
    )
  )


fig_original_tendencia

```

```{r heatmap estacionalidad , include=FALSE}
library(plotly)
library(dplyr)

GLTR_df <- GLTR_df %>%
  mutate(Fecha = as.Date(Fecha))

heatmap_df <- GLTR_df %>%
  filter(Fecha >= "2022-10-31" & Fecha <= "2025-10-31") %>%
  mutate(
    Año = format(Fecha, "%Y"),
    Mes_num = as.numeric(format(Fecha, "%m")),
    Mes = factor(
      Mes_num,
      levels = 1:12,
      labels = c("Ene", "Feb", "Mar", "Abr", "May", "Jun",
                 "Jul", "Ago", "Sep", "Oct", "Nov", "Dic")
    )
  ) %>%
  group_by(Año, Mes, Mes_num) %>%
  summarise(
    Precio_Inicial = first(Precio, order_by = Fecha),
    Precio_Final = last(Precio, order_by = Fecha),
    Precio_Promedio = mean(Precio, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    Rendimiento = ifelse(Precio_Inicial > 0, 
                         (Precio_Final - Precio_Inicial) / Precio_Inicial * 100,
                         0)
  ) %>%
  arrange(Año, Mes_num)

fig_estacionalidad_heatmap <- plot_ly(
  data = heatmap_df,
  x = ~Mes,
  y = ~Año,
  z = ~Rendimiento,
  type = 'heatmap',
  colorscale = list(
    list(0, '#E74C3C'),      
    list(0.5, '#FFFFFF'),    
    list(1, '#00A859')       
  ),
  zmin = -15,  
  zmax = 15,   
  colorbar = list(
    title = "Rendimiento (%)",
    titlefont = list(
      family = "Roboto, sans-serif",
      size = 13,
      color = "#001A5C"  
    ),
    tickfont = list(
      family = "Inter, sans-serif",
      size = 11,
      color = "#5D6D7E"  
    ),
    tickformat = ".1f",
    len = 0.8,
    tickvals = seq(-15, 15, by = 5),  
    outlinecolor = "#D1D8E0", 
    outlinewidth = 1,
    bordercolor = "#D1D8E0",   
    borderwidth = 1,
    bgcolor = "white"
  ),
  hovertemplate = paste(
    '<b>Año</b>: %{y}<br>',
    '<b>Mes</b>: %{x}<br>',
    '<b>Rendimiento</b>: %{z:.2f}%<br>',
    '<b>Precio inicial</b>: $%{text:.2f}<br>',
    '<extra></extra>'
  ),
  text = ~Precio_Inicial
) %>%
  layout(
    title = list(
      text = "<b>Heatmap de Estacionalidad Mensual - Rendimientos por Mes</b>",
      font = list(
        family = "Roboto, sans-serif",
        size = 22,
        color = "#001A5C"  
      ),
      x = 0.5,
      xanchor = "center",
      y = 0.95
    ),
    xaxis = list(
      title = "<b>Mes</b>",
      titlefont = list(
        family = "Roboto, sans-serif",
        size = 16,
        color = "#001A5C"  
      ),
      tickfont = list(
        family = "Inter, sans-serif",
        size = 13,
        color = "#5D6D7E"  
      ),
      tickangle = 0,
      showgrid = FALSE,
      linecolor = "#D1D8E0",  
      linewidth = 1,
      mirror = TRUE
    ),
    yaxis = list(
      title = "<b>Año</b>",
      titlefont = list(
        family = "Roboto, sans-serif",
        size = 16,
        color = "#001A5C"  
      ),
      tickfont = list(
        family = "Inter, sans-serif",
        size = 13,
        color = "#5D6D7E"  
      ),
      autorange = "reversed",
      showgrid = FALSE,
      type = "category",
      linecolor = "#D1D8E0",  
      linewidth = 1,
      mirror = TRUE
    ),
    plot_bgcolor = "white",
    paper_bgcolor = "white",
    margin = list(l = 80, r = 40, t = 100, b = 80),
    annotations = list(
      list(
        x = 0.5,
        y = -0.15,
        text = "<i>Cada celda muestra el rendimiento porcentual mensual. Escala: -15% a +15%. Rojo = rendimiento negativo, Verde = rendimiento positivo.</i>",
        showarrow = FALSE,
        xref = "paper",
        yref = "paper",
        xanchor = "center",
        font = list(
          family = "Inter, sans-serif",
          size = 12,
          color = "#5D6D7E"  
        )
      )
    )
  )


fig_estacionalidad_heatmap

```

```{r volatilidad bandas , include=FALSE}
library(plotly)
library(dplyr)
library(TTR)


volatilidad_df <- GLTR_df %>%
  arrange(Fecha) %>%
  mutate(
    Media_Movil_20 = SMA(Precio, n = 20),
    Desviacion_20 = runSD(Precio, n = 20),
    Banda_Superior = Media_Movil_20 + (2 * Desviacion_20),
    Banda_Inferior = Media_Movil_20 - (2 * Desviacion_20),
    Ancho_Banda = Banda_Superior - Banda_Inferior
  )


fig_bandas <- plot_ly(volatilidad_df, x = ~Fecha) %>%
  
  add_ribbons(
    ymin = ~Banda_Inferior,
    ymax = ~Banda_Superior,
    name = 'Banda de Volatilidad',
    fillcolor = 'rgba(0, 86, 179, 0.1)',
    line = list(color = 'transparent'),
    hovertemplate = 'Ancho: $%{customdata:.2f}<extra></extra>',
    customdata = ~Ancho_Banda  
  ) %>%
  
  add_trace(
    y = ~Precio, 
    type = 'scatter', 
    mode = 'lines',
    name = 'Precio GLTR',
    line = list(color = '#001A5C', width = 1.5),  
    hovertemplate = 'Precio: $%{y:.2f}<extra></extra>'
  ) %>%
  
  add_trace(
    y = ~Media_Movil_20, 
    type = 'scatter', 
    mode = 'lines',
    name = 'Media Móvil 20 días',
    line = list(color = '#00B0F0', width = 2, dash = 'dash'),  
    hovertemplate = 'Media 20d: $%{y:.2f}<extra></extra>'
  ) %>%
  layout(
    title = list(
      text = "<b>Bandas de Volatilidad del ETF GLTR</b><br><sub>Las bandas se expanden en periodos de alta volatilidad y se contraen en calma</sub>",
      font = list(
        family = "Roboto, sans-serif", 
        size = 20,
        color = "#001A5C"  
      )
    ),
    xaxis = list(
      title = "<b>Fecha</b>",
      titlefont = list(
        family = "Roboto, sans-serif",
        size = 14,
        color = "#001A5C"  
      ),
      tickfont = list(
        family = "Inter, sans-serif",
        size = 12,
        color = "#5D6D7E" 
      ),
      rangeslider = list(visible = FALSE),
      showgrid = TRUE,
      gridcolor = 'rgba(233, 236, 241, 0.5)',  
      linecolor = "#0056B3",  
      linewidth = 1
    ),
    yaxis = list(
      title = "<b>Precio (USD)</b>",
      titlefont = list(
        family = "Roboto, sans-serif",
        size = 14,
        color = "#001A5C"  
      ),
      tickfont = list(
        family = "Inter, sans-serif",
        size = 12,
        color = "#5D6D7E"  
      ),
      tickformat = "$.2f",
      showgrid = TRUE,
      gridcolor = 'rgba(233, 236, 241, 0.5)', 
      zeroline = TRUE,
      zerolinecolor = "#0056B3",  
      zerolinewidth = 1
    ),
    plot_bgcolor = 'white',
    paper_bgcolor = 'white',
    hovermode = 'x unified',
    legend = list(
      orientation = "h",
      x = 0.5,
      xanchor = "center",
      y = -0.15,
      font = list(
        family = "Inter, sans-serif",
        size = 13,
        color = "#2E3842" 
      ),
      bgcolor = 'rgba(245, 247, 250, 0.8)', 
      bordercolor = "#D1D8E0",  
      borderwidth = 1
    ),
    updatemenus = list(
      list(
        type = "buttons",
        direction = "right",
        x = 0.3,
        y = 1.15,
        bgcolor = "white",
        bordercolor = "#D1D8E0",  
        borderwidth = 1,
        buttons = list(
          list(
            method = "restyle",
            args = list("visible", c(TRUE, TRUE, TRUE)),
            label = "Mostrar Todo",
            font = list(family = "Inter, sans-serif", size = 12)
          ),
          list(
            method = "restyle",
            args = list("visible", c(TRUE, TRUE, FALSE)),
            label = "Ocultar Media",
            font = list(family = "Inter, sans-serif", size = 12)
          ),
          list(
            method = "restyle",
            args = list("visible", c(TRUE, FALSE, TRUE)),
            label = "Ocultar Precio",
            font = list(family = "Inter, sans-serif", size = 12)
          )
        )
      )
    )
  )

fig_bandas

```

```{r volatilidad , include=FALSE}
library(plotly)
library(dplyr)
library(TTR)
library(zoo)


comparador_volatilidad <- GLTR_df %>%
  arrange(Fecha) %>%
  mutate(
    Rendimiento = (Precio / lag(Precio) - 1) * 100
  ) %>%
  filter(!is.na(Rendimiento)) %>%
  mutate(
    Vol_5d = rollapply(Rendimiento, width = 5, FUN = sd, fill = NA, align = "right"),
    Vol_20d = rollapply(Rendimiento, width = 20, FUN = sd, fill = NA, align = "right"),
    Vol_60d = rollapply(Rendimiento, width = 60, FUN = sd, fill = NA, align = "right"),
    Vol_252d = rollapply(Rendimiento, width = 252, FUN = sd, fill = NA, align = "right")
  )

fig_comparativo <- plot_ly(comparador_volatilidad, x = ~Fecha) %>%
  
  add_trace(
    y = ~Vol_5d,
    type = 'scatter',
    mode = 'lines',
    name = 'Vol 5 días',
    line = list(color = '#00A859', width = 1.5),  
    visible = TRUE,
    hovertemplate = 'Vol 5d: %{y:.2f}%<extra></extra>'
  ) %>%
  
  add_trace(
    y = ~Vol_20d,
    type = 'scatter',
    mode = 'lines',
    name = 'Vol 20 días',
    line = list(color = '#0056B3', width = 2),  
    visible = TRUE,
    hovertemplate = 'Vol 20d: %{y:.2f}%<extra></extra>'
  ) %>%
  
  add_trace(
    y = ~Vol_60d,
    type = 'scatter',
    mode = 'lines',
    name = 'Vol 60 días',
    line = list(color = '#00B0F0', width = 2.5),  
    visible = TRUE,
    hovertemplate = 'Vol 60d: %{y:.2f}%<extra></extra>'
  ) %>%
  
  add_trace(
    y = ~Vol_252d,
    type = 'scatter',
    mode = 'lines',
    name = 'Vol Anual',
    line = list(color = '#001A5C', width = 3),  
    visible = TRUE,
    hovertemplate = 'Vol Anual: %{y:.2f}%<extra></extra>'
  ) %>%
  layout(
    title = list(
      text = "<b>Comparativo de Volatilidad en Diferentes Ventanas Temporales</b>",
      font = list(
        family = "Roboto, sans-serif", 
        size = 20,
        color = "#001A5C"  
      )
    ),
    xaxis = list(
      title = "<b>Fecha</b>",
      titlefont = list(
        family = "Roboto, sans-serif",
        size = 14,
        color = "#001A5C"  
      ),
      tickfont = list(
        family = "Inter, sans-serif",
        size = 12,
        color = "#5D6D7E"  
      ),
      showgrid = TRUE,
      gridcolor = 'rgba(233, 236, 241, 0.5)',  
      linecolor = "#0056B3",  
      linewidth = 1
    ),
    yaxis = list(
      title = "<b>Volatilidad (% desviación estándar)</b>",
      titlefont = list(
        family = "Roboto, sans-serif",
        size = 14,
        color = "#001A5C"  
      ),
      tickfont = list(
        family = "Inter, sans-serif",
        size = 12,
        color = "#5D6D7E"  
      ),
      tickformat = ".1f",
      showgrid = TRUE,
      gridcolor = 'rgba(233, 236, 241, 0.5)', 
      zeroline = TRUE,
      zerolinecolor = "#0056B3",  
      zerolinewidth = 1
    ),
    plot_bgcolor = 'white',
    paper_bgcolor = 'white',
    hovermode = 'x unified',
    legend = list(
      orientation = "h",
      x = 0.5,
      xanchor = "center",
      y = -0.15,
      font = list(
        family = "Inter, sans-serif",
        size = 13,
        color = "#2E3842"  
      ),
      bgcolor = 'rgba(245, 247, 250, 0.8)',  
      bordercolor = "#D1D8E0",  
      borderwidth = 1
    ),
    updatemenus = list(
      list(
        type = "buttons",
        direction = "right",
        x = 0.3,
        y = 1.15,
        bgcolor = "white",
        bordercolor = "#D1D8E0",  
        borderwidth = 1,
        showactive = TRUE,
        buttons = list(
          list(
            method = "restyle",
            args = list("visible", rep(TRUE, 4)),
            label = "Mostrar Todas",
            font = list(family = "Inter, sans-serif", size = 12)
          ),
          list(
            method = "restyle",
            args = list("visible", c(TRUE, FALSE, FALSE, FALSE)),
            label = "Solo 5 días",
            font = list(family = "Inter, sans-serif", size = 12)
          ),
          list(
            method = "restyle",
            args = list("visible", c(FALSE, TRUE, FALSE, FALSE)),
            label = "Solo 20 días",
            font = list(family = "Inter, sans-serif", size = 12)
          ),
          list(
            method = "restyle",
            args = list("visible", c(FALSE, FALSE, TRUE, FALSE)),
            label = "Solo 60 días",
            font = list(family = "Inter, sans-serif", size = 12)
          ),
          list(
            method = "restyle",
            args = list("visible", c(FALSE, FALSE, FALSE, TRUE)),
            label = "Solo Anual",
            font = list(family = "Inter, sans-serif", size = 12)
          )
        )
      )
    )
  )


fig_comparativo

```