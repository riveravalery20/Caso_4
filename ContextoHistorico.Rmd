---
title: "Contexto"
author: "Yo"
date: "2025-12-04"
output: html_document
---

```{r}
library(quantmod)
library(tidyverse)
library(ggplot2)
library(plotly)
library(scales)
library(gridExtra)
library(knitr)
library(kableExtra)
library(RColorBrewer)
library(zoo)
library(tseries)
library(forecast)
library(fpp2)

color_palette <- c(
  "#1E3A8A",  
  "#DC2626",  
  "#059669",  
  "#D97706",  
  "#7C3AED",  
  "#0EA5E9"   
)
```

```{r grafico dona}

library(plotly)
library(dplyr)
library(RColorBrewer)

composition_data <- data.frame(
  Metal = c("Oro Físico", "Plata Física", "Paladio Físico", "Platino Físico"),
  Porcentaje = c(61.77, 30.72, 4.26, 3.26),
  Valor_Mercado = c("1B", "702M", "97M", "74M")
)

composition_data <- composition_data %>%
  mutate(
    Etiqueta = paste0(
      "<b>", Metal, "</b><br>",
      Porcentaje, "%<br>",
      "(", Valor_Mercado, ")"
    ),
    Color = c("#D4AF37", "#C0C0C0", "#B8B8B8", "#E5E4E2"),
    HoverText = paste0(
      "<b>", Metal, "</b><br>",
      "Composición: <b>", Porcentaje, "%</b><br>",
      "Valor de mercado: <b>", Valor_Mercado, "</b><br>",
      "Aproximado en cartera:<br>",
      case_when(
        Metal == "Oro Físico" ~ "60-65%",
        Metal == "Plata Física" ~ "25-30%",
        Metal == "Paladio Físico" ~ "3-5%",
        Metal == "Platino Físico" ~ "3-5%"
      )
    )
  )

donut_interactive <- plot_ly(
  composition_data,
  labels = ~Metal,
  values = ~Porcentaje,
  type = 'pie',
  hole = 0.5,
  textposition = 'outside',
  textinfo = 'label+percent',
  hoverinfo = 'text',
  text = ~HoverText,
  marker = list(
    colors = ~Color,
    line = list(color = '#FFFFFF', width = 3)
  ),
  domain = list(x = c(0, 1), y = c(0, 1))
) %>%
  layout(
    title = list(
      text = "<b>Composición del ETF GLTR</b><br><span style='font-size:14px;'>Aberdeen Standard Physical Precious Metals Basket Shares</span>",
      font = list(
        size = 18,
        color = "#001A5C",
        family = "Roboto, sans-serif"
      ),
      x = 0.5,
      y = 0.95
    ),
    showlegend = TRUE,
    legend = list(
      orientation = "v",
      x = 1.05,
      y = 0.5,
      bgcolor = "#F5F7FA",
      bordercolor = "#D1D8E0",
      borderwidth = 1,
      font = list(
        size = 11,
        family = "Inter, sans-serif",
        color = "#2E3842"
      ),
      title = list(
        text = "<b>Metales Preciosos</b>",
        font = list(
          size = 12,
          family = "Roboto, sans-serif",
          color = "#001A5C"
        )
      )
    ),
    annotations = list(
      list(
        text = "<b style='font-size:16px;color:#001A5C;'>Total AUM</b><br><span style='font-size:14px;color:#0056B3;'>~$1.9B</span>",
        x = 0.5,
        y = 0.5,
        font = list(
          family = "Roboto, sans-serif"
        ),
        showarrow = FALSE
      )
    ),
    paper_bgcolor = "#FFFFFF",
    plot_bgcolor = "#FFFFFF",
    margin = list(t = 120, b = 80, l = 20, r = 180),
    font = list(
      family = "Inter, sans-serif",
      size = 11,
      color = "#2E3842"
    )
  ) %>%
  config(
    displayModeBar = TRUE,
    displaylogo = FALSE,
    modeBarButtonsToRemove = c('pan2d', 'lasso2d', 'select2d')
  )

# Mostrar donut chart
donut_interactive
```


```{r ficha tecnica}
library(kableExtra)

# Crear tabla comparativa estilo profesional
ficha_tecnica <- data.frame(
  Característica = c(
    "Nombre del ETF",
    "Símbolo/Ticker",
    "Tipo de activo",
    "Activos subyacentes",
    "Composición actual",
    "Activos bajo gestión (AUM)",
    "Expense Ratio",
    "Beta (vs. S&P 500)",
    "Rango 52 semanas",
    "Precio actual (aprox)",
    "Rendimiento 2024",
    "Rendimiento YTD 2025",
    "Volumen promedio diario",
    "Bolsa de cotización",
    "Fecha de lanzamiento"
  ),
  Valor = c(
    "Aberdeen Standard Physical Precious Metals Basket Shares ETF",
    "GLTR",
    "ETF de metales preciosos físicos",
    "Oro, plata, paladio, platino físicos",
    "Oro: 62%, Plata: 31%, Paladio: 4%, Platino: 3%",
    "$1,850 millones USD",
    "0.60%",
    "0.21",
    "$109.20 - $171.85",
    "$168.50",
    "+20.3%",
    "+38.5% (hasta octubre)",
    "150,000 acciones",
    "NYSE Arca",
    "Octubre 2010"
  ),
  Nota = c(
    "Nombre completo del instrumento",
    "Ticker de negociación principal",
    "Clasificación del producto",
    "Metales físicos almacenados en bóvedas",
    "Distribución basada en valores de mercado actuales",
    "Ha crecido 35% en los últimos 12 meses",
    "Competitivo dentro del sector de ETFs de metales",
    "Baja correlación con el mercado accionario",
    "Mínimo histórico: $109.20 (Oct 2024)",
    "Precio de cierre más reciente disponible",
    "Impulsado por rally de metales preciosos",
    "Fuerte desempeño por demanda de activos refugio",
    "Alta liquidez para entrada/salida",
    "Principal exchange para ETFs en EE.UU.",
    "Más de 15 años en el mercado"
  )
)

ficha_tecnica %>%
  kable(align = "lcl", 
        caption = "Tabla 1. FICHA TÉCNICA DEL ETF GLTR - METALES PRECIOSOS") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE,
                font_size = 12) %>%
  row_spec(0, background = "#1E3A8A", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "25%") %>%
  column_spec(2, width = "35%") %>%
  column_spec(3, width = "40%", 
              color = "#666666") %>%
  column_spec(2,
              color = ifelse(
                grepl("\\+[0-9]", ficha_tecnica$Valor), "#27AE60",  
                ifelse(
                  grepl("^\\$", ficha_tecnica$Valor), "#3498DB",    
                  "black"
                )
              ),
              bold = ifelse(
                grepl("\\+[0-9]|^\\$", ficha_tecnica$Valor),
                TRUE,
                FALSE
              ))

```

```{r serie}
library(plotly)
library(quantmod)
library(dplyr)
library(zoo)


GLTR <- getSymbols("GLTR", src = "yahoo", auto.assign = FALSE, from = "2010-01-01")


GLTR_df <- data.frame(
  Fecha = index(GLTR),
  Precio = as.numeric(Cl(GLTR))
)

plot_ly(GLTR_df, x = ~Fecha, y = ~Precio, type = "scatter", mode = "lines",
        line = list(color = "#0056B3", width = 2.5),
        hoverinfo = "text",
        text = ~paste("<b>Fecha:</b>", format(Fecha, "%d/%m/%Y"), 
                      "<br><b>Precio:</b> $", round(Precio, 2)),
        name = "Precio de Cierre") %>%
  layout(
    title = list(
      text = "<b>ETF GLTR - Serie Histórica (2010-2025)</b><br><span style='font-size:13px;color:#5D6D7E;'>Aberdeen Standard Physical Precious Metals Basket Shares</span>",
      font = list(
        size = 18,
        color = "#001A5C",
        family = "Roboto, sans-serif"
      ),
      x = 0.5,
      xanchor = "center"
    ),
    xaxis = list(
      title = list(
        text = "<b>Fecha</b>",
        font = list(
          size = 12,
          color = "#0056B3",
          family = "Roboto, sans-serif"
        )
      ),
      tickfont = list(
        size = 10,
        color = "#5D6D7E",
        family = "Inter, sans-serif"
      ),
      showgrid = TRUE,
      gridcolor = "#E8ECF1",
      gridwidth = 0.5,
      showline = TRUE,
      linecolor = "#0056B3",
      linewidth = 1,
      rangeslider = list(
        visible = TRUE,
        bgcolor = "#F5F7FA",
        bordercolor = "#D1D8E0",
        borderwidth = 1,
        thickness = 0.08
      )
    ),
    yaxis = list(
      title = list(
        text = "<b>Precio (USD)</b>",
        font = list(
          size = 12,
          color = "#0056B3",
          family = "Roboto, sans-serif"
        )
      ),
      tickfont = list(
        size = 10,
        color = "#5D6D7E",
        family = "Inter, sans-serif"
      ),
      tickformat = "$,.2f",
      showgrid = TRUE,
      gridcolor = "#E8ECF1",
      gridwidth = 0.5,
      showline = TRUE,
      linecolor = "#0056B3",
      linewidth = 1,
      zeroline = FALSE
    ),
    hovermode = "x unified",
    hoverlabel = list(
      bgcolor = "#FFFFFF",
      bordercolor = "#0056B3",
      font = list(
        family = "Inter, sans-serif",
        size = 11,
        color = "#2E3842"
      )
    ),
    paper_bgcolor = "#FFFFFF",
    plot_bgcolor = "#FFFFFF",
    font = list(
      family = "Inter, sans-serif",
      size = 11,
      color = "#2E3842"
    ),
    margin = list(t = 100, b = 100, l = 80, r = 50),
    legend = list(
      orientation = "h",
      x = 0.5,
      xanchor = "center",
      y = -0.2,
      bgcolor = "#F5F7FA",
      bordercolor = "#D1D8E0",
      borderwidth = 1,
      font = list(
        size = 11,
        family = "Inter, sans-serif",
        color = "#2E3842"
      )
    )
  ) %>%
  config(
    displayModeBar = TRUE,
    displaylogo = FALSE,
    modeBarButtonsToRemove = c('lasso2d', 'select2d'),
    toImageButtonOptions = list(
      format = "png",
      filename = "GLTR_Serie_Historica",
      width = 1200,
      height = 600
    )
  )
```
```{r 2010-2012}

library(quantmod)
library(ggplot2)
library(plotly)

silver_10_12 <- getSymbols("SLV", src = "yahoo", auto.assign = FALSE,
                           from = "2010-01-01", to = "2012-12-31")
silver_10_12_close <- Cl(silver_10_12)

silver_10_12_df <- data.frame(
  fecha  = index(silver_10_12_close),
  precio = as.numeric(silver_10_12_close)
)

g_plata_10_12 <- ggplot(silver_10_12_df, aes(x = fecha, y = precio)) +
  geom_line(color = "#A6ACB5", linewidth = 1.2) +  
  labs(
    title = "Precio de la plata 2010–2012 (proxy: SLV)",
    subtitle = "Rally post-crisis y máximos asociados a QE e inflación esperada",
    x = "Fecha", 
    y = "Precio de cierre (USD)"
  ) +
  theme_minimal() +
  theme(
    
    plot.title = element_text(
      family = 'Roboto',
      color = '#001A5C',
      size = 18,
      face = "bold",
      hjust = 0.5,
      margin = margin(b = 10)
    ),
    
    
    plot.subtitle = element_text(
      family = 'Inter',
      color = '#5D6D7E',
      size = 14,
      hjust = 0.5,
      margin = margin(b = 15)
    ),
    
    
    axis.title = element_text(
      family = 'Roboto',
      color = '#0056B3',
      size = 13,
      face = "bold"
    ),
    
    
    axis.text = element_text(
      family = 'Inter',
      color = '#5D6D7E',
      size = 11
    ),
    
    
    panel.grid.major = element_line(
      color = '#E8ECF1',
      linewidth = 0.5
    ),
    panel.grid.minor = element_blank()
  )


g_plata_10_12_int <- ggplotly(g_plata_10_12) %>%
  layout(
    
    title = list(
      text = "<b>Precio de la plata 2010–2012 (proxy: SLV)</b><br><span style='font-size:14px;color:#5D6D7E'>Rally post-crisis y máximos asociados a QE e inflación esperada</span>",
      font = list(
        family = 'Roboto, Arial',
        size = 18,
        color = '#001A5C'
      ),
      y = 0.95,
      x = 0.5,
      xanchor = 'center',
      yanchor = 'top'
    ),
    
    
    xaxis = list(
      title = list(
        text = "<b>Fecha</b>",
        font = list(
          family = 'Roboto, Arial',
          size = 13,
          color = '#0056B3'
        )
      ),
      tickfont = list(
        family = 'Inter, Arial',
        size = 11,
        color = '#5D6D7E'
      ),
      gridcolor = '#E8ECF1',
      type = 'date',
      tickformat = '%b %Y'
    ),
    
    
    yaxis = list(
      title = list(
        text = "<b>Precio de cierre (USD)</b>",
        font = list(
          family = 'Roboto, Arial',
          size = 13,
          color = '#0056B3'
        )
      ),
      tickfont = list(
        family = 'Inter, Arial',
        size = 11,
        color = '#5D6D7E'
      ),
      gridcolor = '#E8ECF1',
      tickformat = '$.2f'
    ),
    
    
    plot_bgcolor = 'white',
    paper_bgcolor = '#F5F7FA',
    
    
    margin = list(t = 120, b = 80, l = 80, r = 40),
    
    
    hovermode = 'x unified',
    hoverlabel = list(
      bgcolor = 'white',
      bordercolor = '#0056B3',
      font = list(
        family = 'Inter, Arial',
        size = 12,
        color = '#2E3842'
      )
    )
  )


g_plata_10_12_int$x$layout$title <- NULL

g_plata_10_12_int

```



```{r 2020}
library(plotly)
library(quantmod)
library(dplyr)


GLTR <- getSymbols("GLTR", src = "yahoo", auto.assign = FALSE, from = "2020-01-01", to = "2020-12-31")


datos_2020 <- data.frame(
  Fecha = index(GLTR),
  Precio = as.numeric(Cl(GLTR))
)


plot_ly(datos_2020, x = ~Fecha) %>%
  add_trace(y = ~Precio, type = 'scatter', mode = 'lines',
            line = list(color = '#001A5C', width = 3),  
            name = 'Precio GLTR',
            hoverinfo = 'text',
            text = ~paste('<b>Fecha:</b>', Fecha, '<br><b>Precio:</b> $', round(Precio, 2))) %>%
  
  
  add_trace(x = as.Date('2020-03-16'), y = ~Precio[Fecha == as.Date('2020-03-16')],
            type = 'scatter', mode = 'markers',
            marker = list(color = '#E74C3C', size = 12, symbol = 'circle'),  
            name = 'Colapso mercados',
            hoverinfo = 'text',
            text = '<b>16 Mar 2020:</b> Colapso de mercados globales<br>Fed anuncia estímulos de emergencia') %>%
  
  
  add_trace(x = as.Date('2020-08-07'), y = ~Precio[Fecha == as.Date('2020-08-07')],
            type = 'scatter', mode = 'markers',
            marker = list(color = '#D4AF37', size = 12, symbol = 'diamond'),  
            name = 'Récord oro',
            hoverinfo = 'text',
            text = '<b>07 Ago 2020:</b> Oro supera $2,000/oz<br>Rally histórico de metales preciosos') %>%
  
  layout(
    title = list(
      text = '<b>Comportamiento del ETF GLTR durante la Pandemia COVID-19 (2020)</b>',
      font = list(size = 18, color = '#001A5C', family = 'Roboto, Arial'),  
      y = 0.98,
      x = 0.5,
      xanchor = 'center',
      yanchor = 'top'
    ),
    xaxis = list(
      title = '<b>Fecha</b>',
      titlefont = list(family = 'Roboto, Arial'),  
      type = 'date',
      tickformat = '%b %Y',
      tickfont = list(family = 'Inter, Arial'),  
      gridcolor = '#E8ECF1',  
      rangeslider = list(visible = TRUE)
    ),
    yaxis = list(
      title = '<b>Precio (USD)</b>',
      titlefont = list(family = 'Roboto, Arial'),
      tickformat = '$.2f',
      tickfont = list(family = 'Inter, Arial'), 
      gridcolor = '#E8ECF1'  
    ),
    hovermode = 'x unified',
    plot_bgcolor = 'white',
    paper_bgcolor = '#F5F7FA',  
    margin = list(t = 120, b = 80, l = 80, r = 40),
    showlegend = TRUE,
    legend = list(
      orientation = 'h',
      x = 0.5,
      xanchor = 'center',
      y = -0.2,
      yanchor = 'top',
      font = list(family = 'Inter, Arial')  
    )
  )
```

```{r oro 2022}
library(quantmod)
library(ggplot2)
library(plotly)


gold_2022 <- getSymbols("GLD", src = "yahoo", auto.assign = FALSE,
                        from = "2022-01-01", to = "2022-12-31")
gold_2022_close <- Cl(gold_2022)

gold_2022_df <- data.frame(
  fecha  = index(gold_2022_close),
  precio = as.numeric(gold_2022_close)
)


g_oro_2022 <- ggplot(gold_2022_df, aes(x = fecha, y = precio)) +
  geom_line(color = "#D4AF37", linewidth = 1.2) +  
  labs(
    title = "Precio del oro en 2022 (proxy: GLD)",
    subtitle = "Volatilidad por guerra en Ucrania e incremento de tasas",
    x = "Fecha", 
    y = "Precio de cierre (USD)"
  ) +
  theme_minimal() +
  theme(
    
    plot.title = element_text(
      family = 'Roboto',
      color = '#001A5C',
      size = 18,
      face = "bold",
      hjust = 0.5,
      margin = margin(b = 10)
    ),
    
    
    plot.subtitle = element_text(
      family = 'Inter',
      color = '#5D6D7E',
      size = 14,
      hjust = 0.5,
      margin = margin(b = 15)
    ),
    
    
    axis.title = element_text(
      family = 'Roboto',
      color = '#0056B3',
      size = 13,
      face = "bold"
    ),
    
    
    axis.text = element_text(
      family = 'Inter',
      color = '#5D6D7E',
      size = 11
    ),
    
    
    panel.grid.major = element_line(
      color = '#E8ECF1',
      linewidth = 0.5
    ),
    panel.grid.minor = element_blank()
  )


g_oro_2022_int <- ggplotly(g_oro_2022) %>%
  layout(
    
    plot_bgcolor = 'white',
    paper_bgcolor = '#F5F7FA',
    
    
    margin = list(t = 100, b = 80, l = 80, r = 40),
    
    
    hovermode = 'x unified',
    hoverlabel = list(
      bgcolor = 'white',
      bordercolor = '#0056B3',
      font = list(
        family = 'Inter, Arial',
        size = 12,
        color = '#2E3842'
      )
    )
  )


if (!is.null(g_oro_2022_int$x$layout$title)) {
  g_oro_2022_int$x$layout$title <- NULL
}

g_oro_2022_int
```



```{r 2023vs2024}
library(plotly)
library(quantmod)
library(dplyr)
library(tidyr)


GLTR_2023 <- getSymbols("GLTR", src = "yahoo", auto.assign = FALSE, from = "2023-01-01", to = "2023-12-31")
GLTR_2024 <- getSymbols("GLTR", src = "yahoo", auto.assign = FALSE, from = "2024-01-01", to = "2024-12-31")


datos_2023 <- data.frame(
  Fecha = index(GLTR_2023),
  Precio = as.numeric(Cl(GLTR_2023))
) %>%
  mutate(
    Dia = seq_along(Fecha),
    Año = "2023",
    Precio_Norm = Precio / first(Precio) * 100
  )

datos_2024 <- data.frame(
  Fecha = index(GLTR_2024),
  Precio = as.numeric(Cl(GLTR_2024))
) %>%
  mutate(
    Dia = seq_along(Fecha),
    Año = "2024",
    Precio_Norm = Precio / first(Precio) * 100
  )

datos_comparativos <- bind_rows(datos_2023, datos_2024)

plot_ly(datos_comparativos, x = ~Dia) %>%
  add_trace(data = subset(datos_comparativos, Año == "2023"),
            y = ~Precio_Norm,
            type = 'scatter',
            mode = 'lines',
            line = list(color = '#001A5C', width = 3),
            name = '2023',
            hoverinfo = 'text',
            text = ~paste('<b>2023 - Día', Dia, '</b><br>',
                          'Fecha:', Fecha, '<br>',
                          'Precio: $', round(Precio, 2), '<br>',
                          'Normalizado:', round(Precio_Norm, 1))) %>%
  
  
  add_trace(data = subset(datos_comparativos, Año == "2024"),
            y = ~Precio_Norm,
            type = 'scatter',
            mode = 'lines',
            line = list(color = '#00A859', width = 3),  
            name = '2024',
            hoverinfo = 'text',
            text = ~paste('<b>2024 - Día', Dia, '</b><br>',
                          'Fecha:', Fecha, '<br>',
                          'Precio: $', round(Precio, 2), '<br>',
                          'Normalizado:', round(Precio_Norm, 1))) %>%
  
  
  add_trace(x = c(0, max(datos_comparativos$Dia)),
            y = c(100, 100),
            type = 'scatter',
            mode = 'lines',
            line = list(color = '#5D6D7E', width = 1, dash = 'dash'), 
            name = 'Línea base (100)',
            showlegend = FALSE) %>%
  
  layout(
    title = list(
      text = '<b>Comparativo de Desempeño: ETF GLTR 2023 vs 2024</b>',
      font = list(
        family = 'Roboto, Arial',
        size = 22,
        color = '#001A5C'  
      )
    ),
    xaxis = list(
      title = list(
        text = '<b> </b>',
        font = list(
          family = 'Roboto, Arial',
          size = 13,
          color = '#0056B3'  
        )
      ),
      tickfont = list(
        family = 'Inter, Arial',
        size = 11,
        color = '#5D6D7E'  
      ),
      gridcolor = '#E8ECF1'  
    ),
    yaxis = list(
      title = list(
        text = '<b>Precio Normalizado (Inicio = 100)</b>',
        font = list(
          family = 'Roboto, Arial',
          size = 13,
          color = '#0056B3'  
        )
      ),
      tickfont = list(
        family = 'Inter, Arial',
        size = 11,
        color = '#5D6D7E'  
      ),
      gridcolor = '#E8ECF1' 
    ),
    hovermode = 'x unified',
    hoverlabel = list(
      bgcolor = 'white',
      bordercolor = '#0056B3',  
      font = list(
        family = 'Inter, Arial',
        size = 12,
        color = '#2E3842'  
      )
    ),
    plot_bgcolor = 'white',
    paper_bgcolor = '#F5F7FA',  
    legend = list(
      orientation = 'h',
      x = 0.5,
      y = -0.15,
      xanchor = 'center',
      font = list(
        family = 'Inter, Arial',
        size = 11,
        color = '#2E3842'  
      )
    ),
    margin = list(t = 80, b = 100, l = 80, r = 40)
  )
```

```{r desempeño por año}
library(plotly)
library(quantmod)
library(dplyr)
library(lubridate)

GLTR_all <- getSymbols("GLTR", src = "yahoo", auto.assign = FALSE, from = "2023-01-01")

preparar_datos_año <- function(año, datos) {
  
  datos_año <- datos[year(index(datos)) == año]
  
  if (nrow(datos_año) == 0) return(NULL)
  
  
  df <- data.frame(
    Fecha = index(datos_año),
    Precio = as.numeric(Cl(datos_año))
  )
  
  
  df <- df %>%
    mutate(
      Dia_del_año = row_number(),
      Año = as.character(año),
      Precio_Norm = Precio / first(Precio) * 100,
      Retorno = (Precio / first(Precio) - 1) * 100
    )
  
  return(df)
}


datos_2023 <- preparar_datos_año(2023, GLTR_all)
datos_2024 <- preparar_datos_año(2024, GLTR_all)
datos_2025 <- preparar_datos_año(2025, GLTR_all)

datos_todos <- bind_rows(datos_2023, datos_2024, datos_2025)

plot_ly(datos_todos, x = ~Dia_del_año) %>%
  
  add_trace(data = subset(datos_todos, Año == "2023"),
            y = ~Precio_Norm,
            type = 'scatter',
            mode = 'lines+markers',
            line = list(color = '#0056B3', width = 2.5),  
            marker = list(size = 6, color = '#0056B3'),
            name = '2023',
            hoverinfo = 'text',
            text = ~paste('<b>2023 - Día', Dia_del_año, '</b><br>',
                          'Fecha:', format(Fecha, '%d/%m/%Y'), '<br>',
                          'Precio real: $', round(Precio, 2), '<br>',
                          'Normalizado:', round(Precio_Norm, 1), '<br>',
                          'Retorno:', round(Retorno, 1), '%')) %>%
  
  add_trace(data = subset(datos_todos, Año == "2024"),
            y = ~Precio_Norm,
            type = 'scatter',
            mode = 'lines+markers',
            line = list(color = '#00A859', width = 2.5),  
            marker = list(size = 6, color = '#00A859'),
            name = '2024',
            hoverinfo = 'text',
            text = ~paste('<b>2024 - Día', Dia_del_año, '</b><br>',
                          'Fecha:', format(Fecha, '%d/%m/%Y'), '<br>',
                          'Precio real: $', round(Precio, 2), '<br>',
                          'Normalizado:', round(Precio_Norm, 1), '<br>',
                          'Retorno:', round(Retorno, 1), '%')) %>%
  
  add_trace(data = subset(datos_todos, Año == "2025"),
            y = ~Precio_Norm,
            type = 'scatter',
            mode = 'lines+markers',
            line = list(color = '#001A5C', width = 2.5),  
            marker = list(size = 6, color = '#001A5C'),
            name = '2025 (hasta fecha)',
            hoverinfo = 'text',
            text = ~paste('<b>2025 - Día', Dia_del_año, '</b><br>',
                          'Fecha:', format(Fecha, '%d/%m/%Y'), '<br>',
                          'Precio real: $', round(Precio, 2), '<br>',
                          'Normalizado:', round(Precio_Norm, 1), '<br>',
                          'Retorno:', round(Retorno, 1), '%')) %>%
  
  add_trace(x = c(0, max(datos_todos$Dia_del_año, na.rm = TRUE)),
            y = c(100, 100),
            type = 'scatter',
            mode = 'lines',
            line = list(color = '#5D6D7E', width = 1, dash = 'dash'),  
            name = 'Línea base (100)',
            showlegend = FALSE,
            hoverinfo = 'skip') %>%
  
  
  layout(
    title = list(
      text = '<b>Comparativo de Desempeño Anual - ETF GLTR</b><br><span style="font-size:14px;color:#5D6D7E">Cada año normalizado a 100 en su primer día de negociación</span>',
      font = list(
        family = 'Roboto, Arial',
        size = 22,
        color = '#001A5C'  
      )
    ),
    xaxis = list(
      title = list(
        text = '<b> </b>',
        font = list(
          family = 'Roboto, Arial',
          size = 13,
          color = '#0056B3'  
        )
      ),
      tickfont = list(
        family = 'Inter, Arial',
        size = 11,
        color = '#5D6D7E' 
      ),
      gridcolor = '#E8ECF1'  
    ),
    yaxis = list(
      title = list(
        text = '<b>Índice Normalizado (Inicio = 100)</b>',
        font = list(
          family = 'Roboto, Arial',
          size = 13,
          color = '#0056B3'  
        )
      ),
      tickfont = list(
        family = 'Inter, Arial',
        size = 11,
        color = '#5D6D7E'  
      ),
      gridcolor = '#E8ECF1'  
    ),
    hovermode = 'x unified',
    hoverlabel = list(
      bgcolor = 'white',
      bordercolor = '#0056B3',  
      font = list(
        family = 'Inter, Arial',
        size = 12,
        color = '#2E3842'  
      )
    ),
    plot_bgcolor = 'white',
    paper_bgcolor = '#F5F7FA',  
    legend = list(
      orientation = 'h',
      x = 0.5,
      y = -0.15,
      xanchor = 'center',
      bgcolor = 'rgba(255,255,255,0.8)',
      font = list(
        family = 'Inter, Arial',
        size = 11,
        color = '#2E3842'  
      )
    ),
    margin = list(t = 100, b = 100, l = 80, r = 40),
    
    annotations = list(
      list(
        x = max(datos_2023$Dia_del_año, na.rm = TRUE),
        y = tail(datos_2023$Precio_Norm, 1),
        text = paste('2023:', round(tail(datos_2023$Retorno, 1), 1), '%'),
        showarrow = FALSE,
        font = list(
          family = 'Inter, Arial',
          size = 12,
          color = '#0056B3'  
        ),
        xanchor = 'left',
        xshift = 10,
        bgcolor = 'rgba(255,255,255,0.9)',
        bordercolor = '#0056B3',
        borderwidth = 1,
        borderpad = 4
      ),
      list(
        x = max(datos_2024$Dia_del_año, na.rm = TRUE),
        y = tail(datos_2024$Precio_Norm, 1),
        text = paste('2024:', round(tail(datos_2024$Retorno, 1), 1), '%'),
        showarrow = FALSE,
        font = list(
          family = 'Inter, Arial',
          size = 12,
          color = '#00A859'  
        ),
        xanchor = 'left',
        xshift = 10,
        bgcolor = 'rgba(255,255,255,0.9)',
        bordercolor = '#00A859',
        borderwidth = 1,
        borderpad = 4
      ),
      list(
        x = max(datos_2025$Dia_del_año, na.rm = TRUE),
        y = tail(datos_2025$Precio_Norm, 1),
        text = paste('2025:', round(tail(datos_2025$Retorno, 1), 1), '%'),
        showarrow = FALSE,
        font = list(
          family = 'Inter, Arial',
          size = 12,
          color = '#001A5C'  
        ),
        xanchor = 'left',
        xshift = 10,
        bgcolor = 'rgba(255,255,255,0.9)',
        bordercolor = '#001A5C',
        borderwidth = 1,
        borderpad = 4
      )
    )
  )
```

```{r sintesis}

library(kableExtra)

sintesis_historica <- data.frame(
  Período = c(
    "2010–2012",
    "2013–2015", 
    "2016–2019",
    "2020",
    "2021",
    "2022",
    "2023",
    "2024–2025"
  ),
  Comportamiento = c(
    "Rally alcista",
    "Corrección",
    "Laterización volátil",
    "Rally extremo",
    "Corrección",
    "Volatilidad extrema",
    "Recuperación táctica",
    "Rally estructural"
  ),
  Factores_clave = c(
    "Estímulos post-2008, temor inflación, búsqueda refugio",
    "Tapering Fed, fortaleza dólar, normalización monetaria",
    "Incertidumbre política (Brexit, Trump, guerra comercial), tasas moderadas",
    "Pandemia COVID, pánico financiero, QE infinito, máximos oro",
    "Recuperación económica, rotación a cíclicos, normalización de tasas",
    "Invasión Ucrania (alcista) vs. endurecimiento Fed (bajista) → plano",
    "Crisis bancaria puntual, demanda refugio momentánea, luego normalización",
    "Deuda pública ↑, tasas reales esperadas ↓, incertidumbre geopolítica, máximos históricos"
  )
)

sintesis_historica %>%
  kable(
    align = "lll",
    col.names = c("PERÍODO", "COMPORTAMIENTO", "FACTORES CLAVE"),
    caption = "<center><h3 style='color: #1E3A8A;'>Tabla 2. SÍNTESIS HISTÓRICA - TRAYECTORIA DEL ETF GLTR (2010-2025)</h3></center>",
    escape = FALSE
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    font_size = 13,
    fixed_thead = TRUE
  ) %>%
  row_spec(
    0,
    background = "#1E3A8A",
    color = "white",
    bold = TRUE,
    align = "center",
    extra_css = "border-bottom: 2px solid #FFFFFF;"
  ) %>%
  column_spec(
    1,
    bold = TRUE,
    width = "15%",
    background = "#F8FAFC",
    extra_css = "border-right: 1px solid #E5E7EB;"
  ) %>%
  column_spec(
    2,
    width = "20%",
    background = "#FFFFFF",
    extra_css = "border-right: 1px solid #E5E7EB;"
  ) %>%
  column_spec(
    3,
    width = "65%",
    background = "#FFFFFF"
  ) %>%
  footnote(
    general = "Fuente: Análisis histórico basado en datos de Yahoo Finance, Bloomberg y Aberdeen Standard Investments",
    general_title = "Nota:",
    footnote_as_chunk = TRUE,
    title_format = c("italic", "bold")
  )
```

